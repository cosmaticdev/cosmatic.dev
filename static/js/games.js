const platformSVGs = {
    Steam: `
                <svg width="24" height="24" fill="#FFFFFF" viewBox="0 0 32 32" version="1.1"
                            xmlns="http://www.w3.org/2000/svg">
                            <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                            <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
                            <g id="SVGRepo_iconCarrier">
                                <title>steam</title>
                                <path
                                    d="M18.102 12.129c0-0 0-0 0-0.001 0-1.564 1.268-2.831 2.831-2.831s2.831 1.268 2.831 2.831c0 1.564-1.267 2.831-2.831 2.831-0 0-0 0-0.001 0h0c-0 0-0 0-0.001 0-1.563 0-2.83-1.267-2.83-2.83 0-0 0-0 0-0.001v0zM24.691 12.135c0-2.081-1.687-3.768-3.768-3.768s-3.768 1.687-3.768 3.768c0 2.081 1.687 3.768 3.768 3.768v0c2.080-0.003 3.765-1.688 3.768-3.767v-0zM10.427 23.76l-1.841-0.762c0.524 1.078 1.611 1.808 2.868 1.808 1.317 0 2.448-0.801 2.93-1.943l0.008-0.021c0.155-0.362 0.246-0.784 0.246-1.226 0-1.757-1.424-3.181-3.181-3.181-0.405 0-0.792 0.076-1.148 0.213l0.022-0.007 1.903 0.787c0.852 0.364 1.439 1.196 1.439 2.164 0 1.296-1.051 2.347-2.347 2.347-0.324 0-0.632-0.066-0.913-0.184l0.015 0.006zM15.974 1.004c-7.857 0.001-14.301 6.046-14.938 13.738l-0.004 0.054 8.038 3.322c0.668-0.462 1.495-0.737 2.387-0.737 0.001 0 0.002 0 0.002 0h-0c0.079 0 0.156 0.005 0.235 0.008l3.575-5.176v-0.074c0.003-3.12 2.533-5.648 5.653-5.648 3.122 0 5.653 2.531 5.653 5.653s-2.531 5.653-5.653 5.653h-0.131l-5.094 3.638c0 0.065 0.005 0.131 0.005 0.199 0 0.001 0 0.002 0 0.003 0 2.342-1.899 4.241-4.241 4.241-2.047 0-3.756-1.451-4.153-3.38l-0.005-0.027-5.755-2.383c1.841 6.345 7.601 10.905 14.425 10.905 8.281 0 14.994-6.713 14.994-14.994s-6.713-14.994-14.994-14.994c-0 0-0.001 0-0.001 0h0z">
                                </path>
                            </g>
                        </svg>
            `,
    Xbox: `
                <svg width="24" height="24" fill="#FFFFFF" viewBox="0 0 32 32" version="1.1" xmlns="http://www.w3.org/2000/svg" stroke="#FFFFFF"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <title>xbox</title> <path d="M16 5.425c-1.888-1.125-4.106-1.922-6.473-2.249l-0.092-0.010c-0.070-0.005-0.152-0.008-0.234-0.008-0.613 0-1.188 0.16-1.687 0.441l0.017-0.009c2.357-1.634 5.277-2.61 8.426-2.61 0.008 0 0.016 0 0.024 0h0.019c0.005 0 0.011 0 0.018 0 3.157 0 6.086 0.976 8.501 2.642l-0.050-0.033c-0.478-0.272-1.051-0.433-1.662-0.433-0.085 0-0.169 0.003-0.252 0.009l0.011-0.001c-2.459 0.336-4.677 1.13-6.648 2.297l0.082-0.045zM5.554 5.268c-0.041 0.014-0.077 0.032-0.11 0.054l0.002-0.001c-2.758 2.723-4.466 6.504-4.466 10.684 0 3.584 1.256 6.875 3.353 9.457l-0.022-0.028c-1.754-3.261 4.48-12.455 7.61-16.159-3.53-3.521-5.277-4.062-6.015-4.062-0.010-0-0.021-0.001-0.032-0.001-0.115 0-0.225 0.021-0.326 0.060l0.006-0.002zM20.083 9.275c3.129 3.706 9.367 12.908 7.605 16.161 2.075-2.554 3.332-5.845 3.332-9.43 0-4.181-1.709-7.962-4.467-10.684l-0.002-0.002c-0.029-0.021-0.063-0.039-0.1-0.052l-0.003-0.001c-0.1-0.036-0.216-0.056-0.336-0.056-0.005 0-0.011 0-0.016 0h0.001c-0.741-0-2.485 0.543-6.014 4.063zM6.114 27.306c2.627 2.306 6.093 3.714 9.888 3.714s7.261-1.407 9.905-3.728l-0.017 0.015c2.349-2.393-5.402-10.901-9.89-14.29-4.483 3.39-12.24 11.897-9.886 14.29z"></path> </g></svg>
            `,
    Ubisoft: `<svg width="24" height="24" fill="#FFFFFF" viewBox="0 0 32 32"
                            xmlns="http://www.w3.org/2000/svg" stroke="#FFFFFF">
                            <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                            <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
                            <g id="SVGRepo_iconCarrier">
                                <path
                                    d="M31.416 15.984c-0.348-16.391-22.145-22.505-30.541-7.14 0.376 0.276 0.88 0.635 1.256 0.896-0.62 1.296-1.057 2.676-1.303 4.093-0.161 0.912-0.244 1.833-0.244 2.76 0 8.5 6.911 15.407 15.421 15.407 8.516 0 15.411-6.896 15.411-15.407zM4.385 18.729c-0.203 1.667-0.073 2.183-0.073 2.385l-0.375 0.131c-0.14-0.272-0.489-1.24-0.651-2.543-0.407-4.957 2.979-9.421 8.14-10.265 4.724-0.692 9.251 2.245 10.303 6.349l-0.375 0.131c-0.115-0.115-0.303-0.448-1.027-1.172-5.708-5.709-14.672-3.095-15.943 4.989zM19.057 21.505c-0.787 1.135-2.079 1.812-3.453 1.807-2.328 0.005-4.213-1.88-4.208-4.208 0.005-2.197 1.708-4.025 3.901-4.187 1.359-0.057 2.629 0.676 3.224 1.864 0.651 1.301 0.411 2.88-0.604 3.927 0.389 0.276 0.765 0.537 1.14 0.797zM27.828 21.667c-2.224 5.041-6.807 7.688-11.692 7.615-9.381-0.464-12.109-11.287-5.839-15.188l0.276 0.271c-0.104 0.147-0.48 0.439-1.057 1.579-0.677 1.385-0.896 2.776-0.808 3.641 0.489 7.561 11.089 9.109 14.729 1.619 4.641-10.244-7.677-20.667-18.604-12.703l-0.245-0.245c2.876-4.509 8.5-6.52 13.86-5.176 8.197 2.067 12.604 10.609 9.38 18.588z">
                                </path>
                            </g>
                        </svg>
            `
};


async function loadJson() {
    try {
        const response = await fetch('/data');
        return await response.json();
    } catch (error) {
        connectionScore -= 1;
        console.error('Error loading JSON:', error);
    }
}

const data = await loadJson();

function updateESTTime() {
    let estTime = new Date().toLocaleString("en-US", {
        timeZone: "America/New_York",
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit",
        hour12: true // Ensures AM/PM format
    });
    document.getElementById("est-time").textContent = estTime + " EST";
}

updateESTTime();
setInterval(updateESTTime, 1000);

function formatTime(seconds) {
    const days = Math.floor(seconds / 3600 / 24);
    const hrs = Math.floor((seconds % (3600 * 24)) / 3600);
    const mins = Math.floor((seconds % 3600) / 60);
    const secs = Math.floor(seconds % 60);

    let result = [];
    if (days) result.push(`${days} day${days > 1 ? 's' : ''}`);
    if (hrs) result.push(`${hrs} hour${hrs > 1 ? 's' : ''}`);
    if (mins) result.push(`${mins} minute${mins > 1 ? 's' : ''}`);
    result.push(`${secs} second${secs !== 1 ? 's' : ''}`);
    return result.join(", ");
}

function findTopWpm(personalBests) {
    let top = { wpm: 0, category: "" };

    for (const mode in personalBests) {
        for (const subcat in personalBests[mode]) {
            const entry = personalBests[mode][subcat][0];
            if (entry.wpm > top.wpm) {
                top.wpm = entry.wpm;
                top.category = `${subcat} ${mode}`;
            }
        }
    }
    return top;
}

// Populate data
const stats = data.monkeyType.typingStats;
const bests = data.monkeyType.personalBests;
const top = findTopWpm(bests);

document.getElementById("profileLink").href = data.monkeyType.link;
document.getElementById("topWpm").textContent = `${top.wpm} WPM in ${top.category}`;
document.getElementById("typingTime").textContent = `Spent ${formatTime(stats.timeTyping)} typing`;

const showZeroPlaytime = false;

function safeInt(value) {
    const num = Number(value);
    return isNaN(num) ? 0 : Math.floor(num);
}

function parsePlaytimeData(data) {
    const gameStats = {};

    // Steam
    const steamGames = data.steam || [];
    for (const game of steamGames) {
        const playtimeMin = safeInt(game.playtime_forever);
        if ((showZeroPlaytime) || (playtimeMin != 0)) {
            const name = (game.name || "").trim();
            const appid = game.appid;
            const key = name;
            const imUrl = "/static/images/steamThumbnails/" + game.img_icon_url + ".jpg"

            if (!gameStats[key]) {
                gameStats[key] = { playtime: 0, platforms: new Set(), ids: [] };
            }

            gameStats[key].playtime += playtimeMin;
            gameStats[key].platforms.add("Steam");
            gameStats[key].imUrl = imUrl;
            gameStats[key].ids.push(appid);
        }
    }

    // Xbox
    const xboxData = data.XboxPlaytime || {};
    for (const [name, game] of Object.entries(xboxData)) {
        if (name.toLowerCase().trim() === "gamescore") { document.getElementById("gamescoreText").textContent = `Current Xbox gamescore: ${xboxData.gamescore}`; continue; };

        const hours = safeInt(game.hours);
        const minutes = safeInt(game.minutes);
        const totalMinutes = hours * 60 + minutes;
        const key = name;
        const imUrl = "/static/images/xboxThumbnails/" + ((game.thumbnail_url).split("/").slice(-2).join("-"));

        if ((showZeroPlaytime) || (totalMinutes > 0)) {
            if (!gameStats[key]) {
                gameStats[key] = { playtime: 0, platforms: new Set(), ids: [] };
            }

            gameStats[key].playtime += totalMinutes;
            gameStats[key].platforms.add("Xbox");
            gameStats[key].imUrl = imUrl;
            gameStats[key].ids.push(name);  // Use name as ID
        }
    }

    // Ubisoft
    // Ubisoft tracks playtime on top of existing platforms. If we play on steam it will be reflected on Ubisoft, so this is purely to catch playtime on untrackable platforms (geforce now, switch, etc?)
    const ubisoftData = data.Ubisoft || {};
    for (const [name, game] of Object.entries(ubisoftData)) {
        if (name.toLowerCase().trim() === "gamescore") continue;

        const hours = safeInt(game.value / 3600);
        const minutes = safeInt((game.value % 3600) / 60);
        const totalMinutes = hours * 60 + minutes;
        const key = name;
        const imUrl = "/static/images/xboxThumbnails/0008841400-8841437.jpg";

        if ((showZeroPlaytime) || (totalMinutes > 0)) {
            if (!gameStats[key]) {
                gameStats[key] = { playtime: 0, platforms: new Set(), ids: [] };
            }

            if (totalMinutes > gameStats[key].playtime) {
                gameStats[key].playtime = totalMinutes;
            }

            gameStats[key].platforms.add("Ubisoft");
            if (gameStats[key].imUrl == null) {
                gameStats[key].imUrl = imUrl;
            }
            gameStats[key].ids.push(name);  // Use name as ID
        }
    }

    // Roblox
    // WIP
    document.getElementById("robloxText").textContent = `Roblox playtime (since May, 2025): ${formatTime(data.Roblox.playtime)}`

    // Convert and sort
    const result = Object.entries(gameStats).map(([name, info]) => ({
        name,
        playtime_minutes: info.playtime,
        platforms: Array.from(info.platforms),
        imUrl: info.imUrl,
        ids: info.ids,
    }));

    return result.sort((a, b) => b.playtime_minutes - a.playtime_minutes);
}

const sortedGames = parsePlaytimeData(data);

function formatPlaytime(minutes) {
    const hrs = Math.floor(minutes / 60);
    const mins = minutes % 60;
    return `${hrs}h ${mins}m`;
}

const outputDiv = document.getElementById("output");
sortedGames.forEach(game => {
    const card = document.createElement("div");
    card.className = "game-card";

    const img = document.createElement("img");
    img.className = "game-image";
    img.src = game.imUrl;
    img.alt = `${game.name} icon`;

    const infoDiv = document.createElement("div");
    infoDiv.className = "game-info";

    const nameEl = document.createElement("div");
    nameEl.className = "game-name";
    nameEl.textContent = game.name;

    const playtimeEl = document.createElement("div");
    playtimeEl.className = "game-meta";
    playtimeEl.textContent = `Playtime: ${formatPlaytime(game.playtime_minutes)}`;

    infoDiv.appendChild(nameEl);
    infoDiv.appendChild(playtimeEl);

    if (game.achievements !== undefined) {
        const achEl = document.createElement("div");
        achEl.className = "game-meta";
        achEl.textContent = `Achievements: ${game.achievements}`;
        infoDiv.appendChild(achEl);
    }

    const platformIcons = document.createElement("div");
    platformIcons.className = "platform-icons";

    game.platforms.forEach(platform => {
        if (platformSVGs[platform]) {
            const wrapper = document.createElement("span");
            wrapper.innerHTML = platformSVGs[platform];
            platformIcons.appendChild(wrapper.firstElementChild);
        }
    });

    card.appendChild(img);
    card.appendChild(infoDiv);
    card.appendChild(platformIcons);
    outputDiv.appendChild(card);
});


document.getElementById("serverConnection").querySelector("circle").setAttribute("fill", "#00ff11");

document.getElementById("statsFMDays").textContent = `${formatTime(data.statsFM.lifetime.items.durationMs / 1000)} spent streaming Spotify`;

// load brawl stars stats
if (data.brawl_stars["RANKED RANK"] != null) {
    document.getElementById("brawl_starsImage").src = `static/images/rankIcons/brawl_stars/${data.brawl_stars["RANKED RANK"]["images"][0].src.split("/").at(-1).split(".png")[0].split("-").at(-1)}.webp`;
}
document.getElementById("brawl_trophies").textContent = `${data.brawl_stars["TROPHIES"]} Trophies`;

// load valorant stats
document.getElementById("valImage").src = `static/images/rankIcons/valorant/${data.valorant.iconUrl.split("/").at(-1).split(".png")[0]}.png`;
document.getElementById("valSeason").textContent = data.valorant.actName;

// load siege stats
document.getElementById("siegeImage").src = `static/images/rankIcons/siege/${data.siege.metadata.imageUrl.split("/").at(-1).split(".png")[0]}.png`;
document.getElementById("seigePoints").textContent = `${data.siege.value} RP`;

// load rocket league stats
document.getElementById("RLImage").src = `static/images/rankIcons/rocket_league/${data.rocket_league.stats.peakRating.metadata.iconUrl.split("/").at(-1).split("-")[1].split(".png")[0]}.png`;
document.getElementById("RLRank").textContent = `${data.rocket_league.stats.peakRating.metadata.name} ${data.rocket_league.stats.peakRating.metadata.divisionShort}`;